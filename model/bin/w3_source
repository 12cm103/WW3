#!/bin/sh
# --------------------------------------------------------------------------- #
# w3_source : Make a FORTRAN source code file of a selected WAVEWATCH III     #
#             program and put in work directory.                              #
#                                                                             #
# use       : w3_source [program [...]]                                       #
#              program: program name(s) of WAVEWATCH III (sub)program(s).     #
#           - Source codes and make file are put in main directory in a tar   #
#             file, for instance ww3_grid.tar                                 #
#           - Check set-up in section 0.                                      #
#                                                                             #
# error codes : Program ends if error occurs in make_makefile.sh.             #
#                                                                             #
# programs used :                                                             #
#       make_makefile.sh : Make the makefile.                                 #
#                                                                             #
#                                                      Hendrik L. Tolman      #
#                                                      May 2009               #
#                                                      Aug. 2009              #
#                                                                             #
#    Copyright 2009-2010 National Weather Service (NWS),                      #
#       National Oceanic and Atmospheric Administration.  All rights          #
#       reserved.  WAVEWATCH III is a trademark of the NWS.                   #
#       No unauthorized use without permission.                               #
#                                                                             #
# --------------------------------------------------------------------------- #
# 0. Set up                                                                   #
# --------------------------------------------------------------------------- #

  progs="$*"

  if ! [ ${fext} ]
  then
    fext='f90'                      # FORTRAN file extension to be used
  fi

  lext='lst'                        # FORTRAN listing extension
 
  if ! [ ${comp} ]
  then
    comp='ifort'                    # compiler command
  fi

  fflags='-O0 -g -traceback -check all -fpe0 -ftrapuv -openmp -convert big_endian'
                                    # compiler flags, '-c' aut. invoked. 
  ldflags='-O0 -g -traceback -check all -fpe0 -ftrapuv -openmp -convert big_endian'
                                    # loader (linker) flags
  libs=                             # libraries

  cc='cc'
  cflags=

# 0.a.1 Setup file

  ww3_env="${HOME}/.wwatch3.env"                           # setup file
# The following line must not be removed: it is a switch for local install 
# so that all bin scripts point to the local wwatch3.env 
# WW3ENV 
# For manual install (without install_ww3_tar or install_ww3_svn) make sure to 
# either use the generic ww3_env or to add your own ww3_env="${my_directory}" 

  if [ ${WWATCH3_ENV} ]; then ww3_env="${WWATCH3_ENV}"; fi # alternate setup file

# 0.a.2 Get data from setup file - - - - - - - - - - - - - - - - - - - - - - - - 

  if test -f $ww3_env
  then
    set `grep WWATCH3_DIR $ww3_env` ; shift
    WWATCH3_DIR="$*"
    set `grep WWATCH3_TMP $ww3_env` ; shift
    WWATCH3_TMP="$*"
  else
    echo "*** Set-up file $ww3_env not found ***"; echo ' '
    exit 1
  fi

# --------------------------------------------------------------------------- #
# 1. Preparations                                                             #
# --------------------------------------------------------------------------- #

  echo ' '
  echo '               **************************************'
  echo '             ***  making WAVEWATCH III source codes ***'
  echo '               **************************************'
  echo ' '

# 1.a Echo to screen choices for internal variables, directory paths etc
#     screen output of errors

  iexit=0

  echo ' '
  echo '             ***  General setting for W3_SOURCE     ***'
  echo ' '

  if [ ${fext} ]
  then
    echo '           File extension set to:               '$fext
  else
    echo ' ERROR : variable fext not set ' 
    iexit=`expr $iexit + 1`
  fi
  if [ ${comp} ]
  then
    echo '           Compiler set to:                     '$comp
  else
    echo ' ERROR : no compiler defined   '
    iexit=`expr $iexit + 1`
  fi
  if [ ${WWATCH3_DIR} ]
  then
    echo '           Root wwatch3 directory set to:       '${WWATCH3_DIR}
  else
    echo ' ERROR : wwatch3 directory source not defined '
    iexit=`expr $iexit + 1`
  fi
    if [ ${WWATCH3_TMP} ]
  then
    echo '           Temporary scratch directory set to:  '${WWATCH3_TMP}
  else
    echo ' ERROR : temporary directory for scratch not defined '
    iexit=`expr $iexit + 1`
  fi
echo ' '

 if [ $iexit -gt 1 ]; then exit; fi

# Set main_dir to WWATCH3_DIR

  main_dir=${WWATCH3_DIR}
  temp_dir=${WWATCH3_TMP}

# 1.b ID header  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#                moved up

# 1.c Process/save input - - - - - - - - - - - - - - - - - - - - - - - - - - - 

  if [ -z "$progs" ]
  then
    progs='ww3_grid ww3_strt ww3_prep ww3_shel ww3_outf ww3_outp ww3_trck'
    progs="$progs ww3_grib"
    progs="$progs gx_outf gx_outp"
    progs="$progs ww3_multi"
    progs="$progs ww3_sbs1"
    progs="$progs ww3_gint"
    progs="$progs ww3_multi_esmf"
  fi

# 1.d Prepare scratch directory  - - - - - - - - - - - - - - - - - - - - - - - 

  if [ ! -d $temp_dir ]
  then
    if ! `mkdir $temp_dir`
    then
      echo ' ' ; echo "      *** Cannot create $temp_dir ***" ; echo ' '
      exit
    fi
  fi

  cd $temp_dir
  rm -f *.f90 *.$fext *.l makefile
  cd $main_dir/ftn

# 1.e Prepare makefile - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  if [ ! -f $main_dir/bin/switch ]
  then
    echo ' ' ; echo "      *** switch file not found ***" ; echo ' '
    exit
  fi

  echo 'Making makefile ...'
  export WWATCH3_DIR WWATCH3_TMP
  if $main_dir/bin/make_makefile.sh
  then
    cp $main_dir/bin/switch $main_dir/bin/switch.old
  else
    exit 1
  fi

  echo ' '

# --------------------------------------------------------------------------- #
# 2. Make code for all requests                                               #
# --------------------------------------------------------------------------- #
# 2.a Loop over all requests

  for prog in $progs
  do
    echo "Processing $prog.f90"
    echo "-----------------------"
    echo " "

# 2.b Check input  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

    OK='n'
    checks='ww3_grid ww3_strt ww3_prep ww3_shel ww3_outf ww3_outp ww3_trck'
    checks="$checks ww3_grib"
    checks="$checks gx_outf gx_outp"
    checks="$checks ww3_multi ww3_gint ww3_gspl"
    checks="$checks ww3_sbs1"
    checks="$checks ww3_gint"
    checks="$checks ww3_multi_esmf"

    for check in $checks
    do
      if [ "$prog" = "$check" ]
      then
        OK='y'
      fi
    done

    if [ "$OK" = 'n' ]
    then
      echo "   *** Program name not recognized ***"
      echo ' '

# 2.c Get file list from makefile  - - - - - - - - - - - - - - - - - - - - - - 

    else
      set `grep "link $prog" $main_dir/ftn/makefile`
      until [ "$1" = "$prog" ]
      do
        shift
      done
      files=$*
      fors=
        cs=
      objs=

# 2.c Run ad3 to get sources - - - - - - - - - - - - - - - - - - - - - - - - - 

      for file in $files
      do
        ${main_dir}/bin/ad3 $file 0 1
        if [ "$fext" != 'f90' ] ; then
          mv $temp_dir/$file.f90 $temp_dir/$file.$fext ; fi
        if [ -f $temp_dir/$file.$fext ] ; then
          fors="$fors $file.$fext" ; fi
        if [ -f $temp_dir/$file.c ] ; then
          cs="$cs $file.c" ; fi
        objs="$objs $file.o"
        mods="$mods $file.mod"
        lsts="$lsts $file.$lext"
      done

# 2.d Make makefile  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

      cd $temp_dir

      echo 'SHELL=/bin/sh'                                       >> makefile
      echo '#'                                                   >> makefile
      echo "SRCS=	$fors"                                   >> makefile
      echo "OBJS=	$objs"                                   >> makefile
      echo "MODS=	$mods"                                   >> makefile
      echo "LSTS=	$lsts"                                   >> makefile
      echo '#'                                                   >> makefile
      echo "CC =	$cc"                                     >> makefile
      echo "CFLAGS =	$cflags"                                 >> makefile
      echo '#'                                                   >> makefile
      echo "FC =	$comp"                                   >> makefile
      echo "FFLAGS =	$fflags"                                 >> makefile
      echo "LDFLAGS =	$ldflags"                                >> makefile
      echo "LIBS =	$libs"                                   >> makefile
      echo "CMD =	$prog"                                   >> makefile
      echo '#'                                                   >> makefile
      echo 'all:	$(CMD)'                                  >> makefile
      for file in $files
      do
        echo ' '                                                 >> makefile
        sed -n "/^\$(aPo)\/$file.o :/p" $main_dir/ftn/makefile | \
           sed -e 's/\$(aPo)\///g' -e "s/ftn/$fext/g" \
               -e 's/ : /:	/g'                              >> makefile
        if [ -f ./$file.$fext ]
        then
          echo '	$(FC) -c $(FFLAGS)'" $file.$fext"        >> makefile
        fi
        if [ -f ./$file.c ]
        then
          echo '	$(CC) -c $(CFLAGS)'" $file.c"            >> makefile
        fi
      done
      echo ' '                                                   >> makefile
      echo '$(CMD):	$(OBJS)'                                 >> makefile
      echo '	$(FC) $(LDFLAGS) -o $(CMD) $(OBJS) $(LIBS)'      >> makefile
      echo ' '                                                   >> makefile
      echo 'clean:'                                              >> makefile
      echo '	rm -f $(OBJS) $(MODS) $(LSTS)'                   >> makefile
      echo ' '                                                   >> makefile

      tar -cf $main_dir/work/$prog.tar ./*.$fext ./*.c ./makefile
      rm -f *.f90 makefile
      echo ' '
    fi
  done

# --------------------------------------------------------------------------- #
# 3. End of program ID.                                                       #
# --------------------------------------------------------------------------- #

  echo ' '
  echo '                  *********************************'
  echo '                *** end of source code generation ***'
  echo '                  *********************************'
  echo ' '

# End of w3_source ---------------------------------------------------------- #
